<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Gravador de Entrevista ‚Äî Mobile otimizado</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lamejs@1.2.0/lame.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --card-border: rgba(255, 255, 255, 0.1);
      --primary: #8b5cf6;
      --primary-light: #a78bfa;
      --secondary: #0ea5e9;
      --accent: #06d6a0;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --danger: #ef4444;
      --success: #10b981;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
      line-height: 1.5;
      overflow-x: hidden;
    }

    body {
      padding: 16px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      min-height: 100%;
    }

    .container {
      width: 100%;
      max-width: 100%;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      width: 100%;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .title-section {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
    }

    .app-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .app-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 80%;
    }

    .timer-container {
      text-align: center;
      background: rgba(139, 92, 246, 0.1);
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid rgba(139, 92, 246, 0.2);
      min-width: 90px;
    }

    .timer {
      font-size: 22px;
      font-weight: 700;
    }

    .timer-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s ease;
      flex: 1;
      min-width: 120px;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .btn.secondary {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
    }

    .btn.danger {
      background: var(--danger);
      color: white;
    }

    .btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.disabled:active {
      transform: none;
    }

    .visualizer-container {
      margin-bottom: 20px;
    }

    canvas#wave {
      width: 100%;
      height: 80px;
      border-radius: 12px;
      display: block;
      background: rgba(0, 0, 0, 0.2);
    }

    .status {
      margin-bottom: 16px;
      color: var(--text-muted);
      font-size: 14px;
      text-align: center;
      padding: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.03);
    }

    .status span {
      color: var(--text);
      font-weight: 500;
    }

    .audio-preview {
      width: 100%;
      margin-bottom: 16px;
      border-radius: 12px;
      overflow: hidden;
    }

    .download-section {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .download-section .btn {
      flex: 1;
      min-width: 140px;
    }

    .info-panel {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
      padding: 18px;
      margin-top: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .info-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-title::before {
      content: "üí°";
    }

    .info-list {
      margin-left: 20px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .info-list li {
      margin-bottom: 8px;
    }

    footer {
      margin-top: 20px;
      color: var(--text-muted);
      font-size: 12px;
      text-align: center;
      line-height: 1.6;
    }

    /* Sticky mobile controls */
    .sticky-controls {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      z-index: 100;
      padding: 14px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      display: flex;
      gap: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
    }

    .sticky-controls .btn {
      padding: 12px;
      font-size: 16px;
      flex: 1;
    }

    /* Desktop adjustments */
    @media (min-width: 768px) {
      body {
        align-items: center;
        padding: 20px;
      }
      
      .container {
        max-width: 700px;
      }
      
      .card {
        padding: 28px;
      }
      
      header {
        flex-direction: row;
        align-items: center;
      }
      
      .app-subtitle {
        max-width: 100%;
      }
      
      .controls {
        flex-wrap: nowrap;
      }
      
      .btn {
        flex: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="title-section">
          <div>
            <h1 class="app-title">Gravador de Entrevista</h1>
            <p class="app-subtitle">Grave e combine com intro/outro automaticamente</p>
          </div>
          <div class="timer-container">
            <div class="timer" id="timer">00:00</div>
            <div class="timer-label">Dura√ß√£o</div>
          </div>
        </div>
      </header>

      <div class="controls" id="controlsTop">
        <button id="startBtn" class="btn primary">‚ñ∂ Iniciar</button>
        <button id="pauseBtn" class="btn secondary disabled">II Pausar</button>
        <button id="stopBtn" class="btn danger disabled">‚ñ† Parar</button>
        <button id="continueBtn" class="btn secondary disabled">Continuar</button>
      </div>

      <div class="visualizer-container">
        <canvas id="wave"></canvas>
      </div>

      <div class="status">
        Status: <span id="statusText">Pronto para gravar</span>
      </div>

      <audio class="audio-preview" id="preview" controls></audio>

      <div class="download-section">
        <a id="downloadLink" style="display: none" download="entrevista.mp3">
          <button class="btn primary">‚¨áÔ∏è Baixar MP3</button>
        </a>
        <button id="replayBtn" class="btn secondary" style="display: none">‚ñ∂ Reproduzir</button>
      </div>

      <div class="info-panel">
        <h3 class="info-title">Como usar</h3>
        <ol class="info-list">
          <li>Permita o acesso ao microfone quando solicitado</li>
          <li>Toque em "Iniciar" para come√ßar a gravar</li>
          <li>Use "Pausar" e "Parar" conforme necess√°rio</li>
          <li>Toque em "Continuar" para processar o √°udio</li>
          <li>Baixe o MP3 final com intro e outro inclu√≠dos</li>
        </ol>
      </div>

      <footer>
        <p>Os arquivos <strong>inicio.mp3</strong> e <strong>fim.mp3</strong> ser√£o automaticamente adicionados ao in√≠cio e fim da grava√ß√£o.</p>
      </footer>
    </div>
  </div>

  <!-- Sticky mobile controls -->
  <div id="stickyControls" class="sticky-controls" style="display: none">
    <button id="startBtnMobile" class="btn primary">‚ñ∂</button>
    <button id="pauseBtnMobile" class="btn secondary disabled">II</button>
    <button id="stopBtnMobile" class="btn danger disabled">‚ñ†</button>
    <button id="continueBtnMobile" class="btn secondary disabled">Cont.</button>
  </div>

  <script>
    (async function(){
      // Elementos principais
      const startBtn = document.getElementById('startBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const stopBtn = document.getElementById('stopBtn');
      const continueBtn = document.getElementById('continueBtn');
      const downloadLink = document.getElementById('downloadLink');
      const preview = document.getElementById('preview');
      const statusText = document.getElementById('statusText');
      const timerEl = document.getElementById('timer');
      const waveCanv = document.getElementById('wave');
      const replayBtn = document.getElementById('replayBtn');

      // Controles m√≥veis sticky
      const sticky = document.getElementById('stickyControls');
      const startBtnMobile = document.getElementById('startBtnMobile');
      const pauseBtnMobile = document.getElementById('pauseBtnMobile');
      const stopBtnMobile = document.getElementById('stopBtnMobile');
      const continueBtnMobile = document.getElementById('continueBtnMobile');

      // Vari√°veis de estado
      let mediaRecorder = null;
      let chunks = [];
      let recordingBlob = null;
      let streamRef = null;
      let startTime = 0, elapsed = 0, timerInterval = null;
      let isPaused = false;

      // Configura√ß√£o de √°udio
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      let analyser = audioCtx.createAnalyser();
      analyser.fftSize = 1024; // Reduzido para melhor performance em mobile
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      // Configura√ß√£o do canvas de onda
      function resizeCanvas(){
        const dpr = devicePixelRatio || 1;
        waveCanv.width = waveCanv.clientWidth * dpr;
        waveCanv.height = Math.max(48, waveCanv.clientHeight) * dpr;
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      const canvasCtx = waveCanv.getContext('2d');

      // Desenho da onda de √°udio
      function drawWave(){
        requestAnimationFrame(drawWave);
        analyser.getByteTimeDomainData(dataArray);
        
        canvasCtx.fillStyle = 'rgba(15, 23, 42, 0.8)';
        canvasCtx.fillRect(0, 0, waveCanv.width, waveCanv.height);
        
        canvasCtx.lineWidth = 2 * (devicePixelRatio || 1);
        canvasCtx.strokeStyle = 'rgba(139, 92, 246, 0.7)';
        canvasCtx.beginPath();
        
        const sliceWidth = waveCanv.width / bufferLength;
        let x = 0;
        
        for(let i = 0; i < bufferLength; i++){
          const v = dataArray[i] / 128.0;
          const y = (v * waveCanv.height) / 2;
          
          if(i === 0) {
            canvasCtx.moveTo(x, y);
          } else {
            canvasCtx.lineTo(x, y);
          }
          
          x += sliceWidth;
        }
        
        canvasCtx.stroke();
      }
      drawWave();

      // Fun√ß√µes auxiliares
      function setStatus(s) { 
        statusText.textContent = s; 
      }

      function enable(el, val) { 
        if(!el) return; 
        if(val) { 
          el.classList.remove('disabled'); 
          el.disabled = false; 
        } else { 
          el.classList.add('disabled'); 
          el.disabled = true; 
        } 
      }

      function startTimer() { 
        startTime = Date.now(); 
        timerInterval = setInterval(() => {
          elapsed = Math.floor((Date.now() - startTime) / 1000);
          const mm = String(Math.floor(elapsed / 60)).padStart(2, '0');
          const ss = String(elapsed % 60).padStart(2, '0');
          timerEl.textContent = `${mm}:${ss}`;
        }, 250); 
      }

      function stopTimer() { 
        clearInterval(timerInterval); 
      }

      // Iniciar grava√ß√£o
      async function startRecording(){
        try{
          setStatus('Solicitando acesso ao microfone...');
          const s = await navigator.mediaDevices.getUserMedia({ 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              sampleRate: 44100,
              channelCount: 1
            } 
          });
          streamRef = s;
          mediaRecorder = new MediaRecorder(s, {
            mimeType: 'audio/webm;codecs=opus'
          });
          chunks = [];

          const src = audioCtx.createMediaStreamSource(s);
          src.connect(analyser);

          mediaRecorder.ondataavailable = e => { 
            if(e.data && e.data.size > 0) {
              chunks.push(e.data);
            }
          };
          
          mediaRecorder.onstop = async () => {
            try {
              setStatus('Processando grava√ß√£o...');
              recordingBlob = new Blob(chunks, { type: 'audio/webm' });
              preview.src = URL.createObjectURL(recordingBlob);
              enable(continueBtn, true); 
              enable(continueBtnMobile, true);
              setStatus('Grava√ß√£o conclu√≠da. Toque em "Continuar" para processar.');
              
              if(streamRef){ 
                streamRef.getTracks().forEach(t => t.stop()); 
                streamRef = null; 
              }
            } catch (err) {
              console.error('Erro ao processar grava√ß√£o:', err);
              setStatus('Erro ao processar grava√ß√£o');
            }
            
            stopTimer();
          };

          mediaRecorder.start(100); // Coletar dados a cada 100ms para melhor performance
          setStatus('Gravando...');
          enable(pauseBtn, true); 
          enable(pauseBtnMobile, true);
          enable(stopBtn, true); 
          enable(stopBtnMobile, true);
          enable(startBtn, false); 
          enable(startBtnMobile, false);
          enable(continueBtn, false);
          enable(continueBtnMobile, false);
          isPaused = false;
          startTimer();

        } catch(err) { 
          console.error(err); 
          setStatus('Erro: ' + err.message); 
        }
      }

      // Conectar eventos dos bot√µes
      startBtn.addEventListener('click', startRecording);
      startBtnMobile.addEventListener('click', startRecording);

      pauseBtn.addEventListener('click', () => { 
        if(mediaRecorder && mediaRecorder.state === 'recording'){ 
          mediaRecorder.pause(); 
          setStatus('Pausado'); 
          enable(pauseBtn, false); 
          enable(pauseBtnMobile, false); 
          isPaused = true;
          stopTimer(); 
        } 
      });
      
      pauseBtnMobile.addEventListener('click', () => { 
        if(mediaRecorder && mediaRecorder.state === 'recording'){ 
          mediaRecorder.pause(); 
          setStatus('Pausado'); 
          enable(pauseBtn, false); 
          enable(pauseBtnMobile, false); 
          isPaused = true;
          stopTimer(); 
        } 
      });

      // Bot√£o de retomar
      const resumeBtn = document.createElement('button');
      resumeBtn.textContent = '‚Üª Retomar';
      resumeBtn.className = 'btn secondary disabled';
      resumeBtn.addEventListener('click', () => {
        if(mediaRecorder && mediaRecorder.state === 'paused'){ 
          mediaRecorder.resume(); 
          setStatus('Gravando...'); 
          enable(pauseBtn, true); 
          enable(pauseBtnMobile, true); 
          enable(resumeBtn, false); 
          isPaused = false;
          startTimer(); 
        } 
      });
      
      // Inserir o bot√£o de retomar ap√≥s o bot√£o de pausar
      pauseBtn.parentNode.insertBefore(resumeBtn, pauseBtn.nextSibling);

      // Adicionar tamb√©m para mobile
      const resumeBtnMobile = document.createElement('button');
      resumeBtnMobile.textContent = '‚Üª';
      resumeBtnMobile.className = 'btn secondary disabled';
      resumeBtnMobile.addEventListener('click', () => {
        if(mediaRecorder && mediaRecorder.state === 'paused'){ 
          mediaRecorder.resume(); 
          setStatus('Gravando...'); 
          enable(pauseBtn, true); 
          enable(pauseBtnMobile, true); 
          enable(resumeBtnMobile, false); 
          isPaused = false;
          startTimer(); 
        } 
      });

      stopBtn.addEventListener('click', () => { 
        if(mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')){ 
          mediaRecorder.stop(); 
          setStatus('Finalizando grava√ß√£o...'); 
          enable(stopBtn, false); 
          enable(stopBtnMobile, false); 
          enable(pauseBtn, false); 
          enable(pauseBtnMobile, false); 
          enable(resumeBtn, false);
          enable(resumeBtnMobile, false);
          enable(startBtn, true); 
          enable(startBtnMobile, true); 
          isPaused = false;
        } 
      });
      
      stopBtnMobile.addEventListener('click', () => { 
        if(mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused')){ 
          mediaRecorder.stop(); 
          setStatus('Finalizando grava√ß√£o...'); 
          enable(stopBtn, false); 
          enable(stopBtnMobile, false); 
          enable(startBtn, true); 
          enable(startBtnMobile, true); 
          isPaused = false;
        } 
      });

      replayBtn.addEventListener('click', () => { 
        if(preview.src) preview.play(); 
      });

      // Processamento de arquivos de √°udio
      async function fetchAndDecodeFile(filename){
        try{
          const resp = await fetch(filename);
          if(!resp.ok) {
            setStatus(`Erro: Arquivo ${filename} n√£o encontrado`);
            throw new Error(`Arquivo ${filename} n√£o encontrado`);
          }
          const ab = await resp.arrayBuffer();
          return await audioCtx.decodeAudioData(ab.slice(0));
        } catch(e) { 
          console.warn('N√£o foi poss√≠vel carregar', filename, e); 
          setStatus(`Erro ao carregar ${filename}`);
          throw e;
        }
      }

      function toMonoFloat32(buffer){
        const ch = buffer.numberOfChannels; 
        const len = buffer.length; 
        const result = new Float32Array(len);
        for(let c = 0; c < ch; c++){ 
          const data = buffer.getChannelData(c); 
          for(let i = 0; i < len; i++) 
            result[i] = (result[i] || 0) + data[i] / ch; 
        } 
        return result;
      }
      
      function concatFloat32(arrays){ 
        let totalLen = arrays.reduce((s, a) => s + a.length, 0); 
        const out = new Float32Array(totalLen); 
        let offset = 0; 
        for(const a of arrays){ 
          out.set(a, offset); 
          offset += a.length; 
        } 
        return out; 
      }
      
      function floatTo16BitPCM(float32){ 
        const l = float32.length; 
        const out = new Int16Array(l); 
        for(let i = 0; i < l; i++){ 
          let s = Math.max(-1, Math.min(1, float32[i])); 
          out[i] = s < 0 ? s * 0x8000 : s * 0x7FFF; 
        } 
        return out; 
      }

      // Processar √°udio e gerar MP3
      async function processAudio(){
        if(!recordingBlob){ 
          setStatus('Nenhuma grava√ß√£o dispon√≠vel.'); 
          return; 
        }
        
        enable(continueBtn, false); 
        enable(continueBtnMobile, false);
        setStatus('Carregando √°udios de in√≠cio e fim...');
        
        try{
          const [introBuf, outroBuf] = await Promise.all([
            fetchAndDecodeFile('inicio.mp3'),
            fetchAndDecodeFile('fim.mp3')
          ]);
          
          setStatus('Processando grava√ß√£o...');
          const recAB = await recordingBlob.arrayBuffer();
          const recBuf = await audioCtx.decodeAudioData(recAB.slice(0));
          const segments = [];
          
          // Adicionar intro, grava√ß√£o e outro
          segments.push(toMonoFloat32(introBuf));
          segments.push(toMonoFloat32(recBuf));
          segments.push(toMonoFloat32(outroBuf));
          
          const combined = concatFloat32(segments);
          const sampleRate = recBuf.sampleRate || audioCtx.sampleRate || 44100;
          setStatus('Codificando MP3 (320 kbps)...');

          // Codifica√ß√£o com lamejs em 320 kbps (fixo)
          const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, 320);
          const samples16 = floatTo16BitPCM(combined);
          const mp3Data = [];
          const maxSamples = 1152 * 6; // Tamanho otimizado para mobile
          
          for(let i = 0; i < samples16.length; i += maxSamples){
            const chunk = samples16.subarray(i, i + maxSamples);
            const mp3buf = mp3Encoder.encodeBuffer(chunk);
            if(mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf));
          }
          
          const mp3buf = mp3Encoder.flush(); 
          if(mp3buf.length > 0) mp3Data.push(new Int8Array(mp3buf));
          
          const mp3Blob = new Blob(mp3Data, { type: 'audio/mpeg' });
          const url = URL.createObjectURL(mp3Blob);
          downloadLink.href = url; 
          downloadLink.style.display = 'block'; 
          preview.src = url; 
          replayBtn.style.display = 'inline-flex'; 
          setStatus('MP3 pronto para download!'); 
          downloadLink.download = 'entrevista.mp3';
          
        } catch(err) { 
          console.error(err); 
          setStatus('Erro ao processar √°udio: ' + (err.message || err)); 
          enable(continueBtn, true); 
          enable(continueBtnMobile, true); 
        }
      }

      continueBtn.addEventListener('click', processAudio);
      continueBtnMobile.addEventListener('click', processAudio);

      // Mostrar/ocultar controles sticky no mobile
      function updateSticky(){ 
        if(window.innerWidth <= 768){ 
          sticky.style.display = 'flex'; 
          
          // Adicionar bot√£o de retomar para mobile se ainda n√£o estiver l√°
          if (!document.getElementById('resumeBtnMobile')) {
            const resumeBtnMobile = document.createElement('button');
            resumeBtnMobile.id = 'resumeBtnMobile';
            resumeBtnMobile.textContent = '‚Üª';
            resumeBtnMobile.className = 'btn secondary disabled';
            resumeBtnMobile.addEventListener('click', () => {
              if(mediaRecorder && mediaRecorder.state === 'paused'){ 
                mediaRecorder.resume(); 
                setStatus('Gravando...'); 
                enable(pauseBtnMobile, true); 
                enable(resumeBtnMobile, false); 
                isPaused = false;
                startTimer(); 
              } 
            });
            pauseBtnMobile.parentNode.insertBefore(resumeBtnMobile, pauseBtnMobile.nextSibling);
          }
        } else { 
          sticky.style.display = 'none'; 
        } 
      }
      
      updateSticky(); 
      window.addEventListener('resize', updateSticky);

    })();
  </script>
</body>
</html>
